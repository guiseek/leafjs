#!/usr/bin/env node
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/core"),t=require("fs"),r=require("path"),l=require("glob"),n=require("rollup"),o=require("@rollup/plugin-node-resolve"),a=require("@rollup/plugin-commonjs"),i=require("rollup-plugin-terser"),s=require("commander"),u=require("@rollup/plugin-babel"),c=require("@rollup/plugin-inject"),d=require("chalk"),f=require("rollup-plugin-progress"),p=require("express"),g=require("express-ws"),m=require("chokidar");function b(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var y=b(e),_=b(t),x=b(r),j=b(l),v=b(o),S=b(a),w=b(c),h=b(d),q=b(f),E=b(p),$=b(g),F=b(m);const R=require("open"),D={presets:[["@babel/preset-env",{modules:!1,targets:"> 0.25%, not dead"}]],plugins:[["@babel/plugin-transform-react-jsx",{pragma:"___leaf_create_element_react"}]],babelHelpers:"bundled"},N=new s.Command,O=e=>{console.log(`${h.default.cyan("[leafjs]")} - ${h.default.blue("info")} - ${e}`)},C=e=>{console.log(`${h.default.cyan("[leafjs]")} - ${h.default.red("error")} - ${e}`)},T=e=>{var t;return(null===(t=y.default.transformSync((e=>`\n    /** @jsx ___createElement_leaf */\n    import { createElementReactStyle as ___createElement_leaf } from '@leaf-web/core';\n    \n    // user code start\n    ${e};\n    // user code end\n  `)(e),D))||void 0===t?void 0:t.code)||""},k=e=>[".jsx",".tsx"].includes(x.default.extname(e))?e.substring(0,e.length-1):e,L=(e,t)=>{const r=_.default.readFileSync(x.default.resolve(e)).toString(),l=T(r);let n=k(x.default.resolve(t));return _.default.writeFileSync(n,"// NOTE: This file is generated by Leafjs parser. DO NOT EDIT!\n\n"+l),l},J=async(e,t)=>{const r={input:e,plugins:[v.default(),S.default(),u.babel(D),w.default({___leaf_create_element_react:["@leaf-web/core","createElementReactStyle"]}),i.terser(),q.default()]},l={format:"iife",file:x.default.join(t,"bundle.min.js")};let o=null,a=!1;try{o=await n.rollup(r),await o.write(l)}catch(e){a=!0,C(`failed to compile.\n${h.default.gray(e)}`)}o&&await o.close(),a&&process.exit(1)},I=async e=>{const t=JSON.parse(_.default.readFileSync(e).toString());await J(t.entry,t.outputDir)},B=(e,r)=>{const l=JSON.parse(_.default.readFileSync(e).toString()),o={input:l.entry,plugins:[v.default(),S.default(),u.babel(D),w.default({___leaf_create_element_react:["@leaf-web/core","createElementReactStyle"]}),q.default()]},a={format:"iife",file:x.default.join(l.outputDir,"bundle.min.js")},i=n.watch({...o,output:a});let s=null;const c=(e=>{e=x.default.resolve(e);const r=E.default(),l=$.default(r),n=[new RegExp("</body>","i"),new RegExp("</svg>"),new RegExp("</head>","i")];let o=null;const a=t.readFileSync(x.default.join(__dirname,"injected.min.js")).toString(),i=l=>{const s=t.readdirSync(l);for(const u of s){const s=x.default.join(l,u);if(t.statSync(s).isDirectory())i(s);else{if(".html"!==x.default.extname(s))continue;const l=t.readFileSync(s).toString();for(const e of n){const t=e.exec(l);if(t){o=t[0];break}}const i=x.default.parse(x.default.relative(e,s));r.get(x.default.join("/",i.dir,"index"===i.name?"":i.name),((e,t)=>{o?t.send(l.replace(new RegExp(o,"i"),`\n          \x3c!-- code injected by leafjs --\x3e\n          <script>\n              ${a}\n          <\/script>\n      ${o}`)):t.send(l)}))}}};r.use("/",E.default.static(e,{index:!1})),i(e);let s=null;return l.app.ws("/socket",(e=>{s=e})),{start:r.listen,update:()=>{null==s||s.send(JSON.stringify({msg:"reload"}))},error:e=>{null==s||s.send(JSON.stringify({msg:"error",data:e}))},on:l.app.on}})(".");c.start(r,(async()=>{O(`started development server on http://localhost:${r}.`),await R(`http://127.0.0.1:${r}/`)})),c.on("error",(e=>{C(`Failed to start development server.\n${h.default.gray(e)}`)}));const d=()=>{process.stdout.moveCursor(0,-1e4),process.stdout.cursorTo(0),process.stdout.clearScreenDown()};let f=!0;i.on("event",(e=>{"START"===e.code?(f=!0,d(),O("building..."),s=null):"END"===e.code?(s?(C("an unexpected error occured while building."),c.error(s.message)):(d(),O("build successful.")),f=!1):"ERROR"===e.code?(C(`failed to build.\n${h.default.gray(e.error)}`),s=e.error):"BUNDLE_END"===e.code&&e.result.close()}));F.default.watch(".",{ignored:["node_modules","**/*.jsx","**/*.tsx"]}).on("all",(()=>{f||s||(O("change detected to filesystem. reloading..."),c.update(),d(),O("waiting for changes..."))}))};N.name("leaf").description("Leafjs helper CLI."),N.command("build").description("Build and bundle a Leafjs application.").option("-c, --config <string>","Config file location.","./leaf.config.json").action((async e=>{O("compiling..."),await I(e.config),O("compiled successfully.")})),N.command("dev").description("Start a development server.").option("-c, --config <string>","Config file location.","./leaf.config.json").option("-p, --port <number>","Port to start the development server.","8080").action((e=>{B(e.config,parseInt(e.port))})),N.parse(),exports.buildFromConfig=I,exports.bundleFiles=J,exports.compileCode=T,exports.compileFile=L,exports.compileFilesWithGlob=(e,t)=>{j.default(e,((e,r)=>{e?C(`failed to match glob files.\n${h.default.gray(e)}`):r.forEach((e=>{const r=x.default.join(t,e),l=x.default.dirname(r);_.default.mkdir(l,{recursive:!0},(t=>{t?console.error(t):L(e,r)}))}))}))},exports.error=C,exports.info=O,exports.startDevServer=B,exports.transformFilename=k;
//# sourceMappingURL=parser.min.js.map
